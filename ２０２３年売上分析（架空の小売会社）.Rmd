---
title: "２０２３年売上分析（架空の小売会社）"
author: "Yoshiki Okada"
date: "2025-09-05"
output: html_document
---

```{r setup, include=FALSE}
library("tidyverse")  
library("conflicted")
library("skimr")
library("patchwork")

conflict_prefer("filter", "dplyr")
conflict_prefer("lag", "dplyr")
knitr::opts_chunk$set(echo = TRUE)
```

## **1. 初めに**

### **1.1. 背景**

本レポートは、架空小売会社の年間売上の合成データを用いて、売上傾向を分析したものです。
特に、月別の売上変動が大きい製品カテゴリに注目し、顧客属性が売り上げに与える影響を調査します。
分析から得られた知見をもとに、売上向上に向けた実務的な示唆を提示します。
<br><br>

### **1.2. データの出典・概要**

本分析で使用したデータは、データサイエンスと機械学習に特化したオンラインプラットフォーム「Kaggle」にて公開されているものです。

対象としたデータセットは**Retail Sales Dataset** (Talib, 2023)で、以下のリンクからダウンロード可能です。[`ダウンロードリンク`](https://www.kaggle.com/datasets/mohammadtalib786/retail-sales-dataset/data)

**データセットのライセンス**: [`CC0: Public Domain`](https://creativecommons.org/publicdomain/zero/1.0/) 
<br><br>

**データセットの主要な変数は以下の通りです:**

- Transaction.ID: 取引ID
- Date: 取引日(西暦ー月ー日)
- Customer.ID: 顧客ID
- Gender: 顧客の性別(男性、 女性)
- Age: 顧客の年齢(１８歳～６４歳)
- Product.Category: 製品カテゴリ[「Beauty（美容・パーソナルケア）」、「Clothing（衣類）」、「Electronics（家庭用電気製品（以下、家電））」]
- Quantity: 購入点数
- Price.per.Unit: 価格（各商品の値段）
- Total.Amount: 合計金額（取引ごとの会計）

元のデータの「価格」と「合計金額」には通貨記号が含まれていませんでした。本レポートでは、透明性のためアメリカドル（USD、＄）として扱います。
<br><br>

## **2. データ整形と前処理**

1. 各列のデータ型および値を確認し、欠損や異常値は存在しないと判断しました。
2. 列間の整合性の確認を行いましたが、問題は見受けられませんでした。
3. 月単位での集計のため、取引日を日付型に変更した後、西暦、月、日の列を追加しました。
4. 分析を簡易化するため、一部の列名を簡潔かつ理解しやすい形式に変更しました。（例：Transaction.ID -> transaction_id, Price.Per.Unit -> unit_priceなど。）
5. 保管用のデータを確保しつつ、同時に不要な列を除外したデータを別途作成しました。


```{r}
# ファイルのロード
sales_df <- read.csv("retail_sales_dataset.csv")

# データ型の変更
sales_date_df <- sales_df %>%
  mutate(date_num = as.Date(Date),
         year = format(date_num, "%Y"),　
         month = format(date_num, "%m"), 
         day = format(date_num, "%d")) %>% 
  select(Transaction.ID, Date, year, month, day, everything())

# 列名変更
sales_rename <- sales_date_df %>%
  rename(transaction_id = Transaction.ID, 
         customer_id = Customer.ID, 
         product_category = Product.Category, 
         unit_price = Price.per.Unit, 
         total_amount = Total.Amount)

# 列の除去と保管用の作成
sales_use <- sales_rename %>%
  select(-date_num)


```

<br><br>

## **3. 分析手法**

本分析では、売上の変動要因を明らかにするために、記述統計・可視化・クロス集計を主に用いました。

**選択手法及びその目的：**

- **全体像の把握：** 月次売上および製品カテゴリ別の売上の全体傾向を直感的に示すために、面グラフによる可視化を行いました。

- **製品カテゴリ比較：** 製品カテゴリごとの月次売上の傾向把握および比較のために、折れ線グラフによる可視化を行いました。

- **顧客属性分析：** 各属性の月次構成比を確認するために、積み上げ棒グラフによる可視化を行いました。

- **来店人数・平均取引単価（以下、単価）：** 売上変動に寄与する「人数要因」と「単価要因」を切り分け、個々に推移を分析するために、それぞれ折れ線グラフによる可視化を行いました。

- **販売個数・平均購入点数：** 売上変動に寄与する「単価要因」を分解し、把握するために、それぞれ折れ線グラフによる可視化と記述統計を行いました。

- **製品カテゴリ別平均販売価格および販売割合（以下、平均販売価格・販売割合）：** 「単価要因」をさらに深堀し、その変動要因を特定するために、それぞれ折れ線グラフと棒グラフによる可視化を行いました。

統計分析に関しては、回帰分析を試みましたが、サンプル数不足により有意性を確認できなかったため、本レポートの結論には含めていません。
<br><br>

## **4. 結果と考察**

このセクションでは、全体傾向を確認した後、売上変動に影響を及ぼす要因の可視化を行います。<br><br>

### **4.1. 全体傾向**

売上向上という目標達成のために、まず全体的な売上傾向を把握することから始めます。

```{r 全体傾向, echo=FALSE}
# データの集計
overall_sales <- sales_use %>%
  group_by(month, product_category) %>%
  summarise(monthly_category_sales = sum(total_amount, na.rm = TRUE),
            .groups = "drop") %>%    
  group_by(month) %>%
  mutate(monthly_total_sales = sum(monthly_category_sales),
         date = as.Date(paste0("2023-", month, "-01"))) %>%
  select(date, month, everything())


```

**面グラフ**

```{r グラフ: 全体傾向}
# 面グラフ
ggplot(data = overall_sales) + 
  geom_area(aes(x = date, 
                y = monthly_category_sales, 
                fill = product_category), 
            alpha = 0.5) +
  geom_line(aes(x = date, 
                y = monthly_total_sales), 
            alpha = 0) +
  geom_text(aes(x = date, 
                y = monthly_total_sales, 
                label = paste0("$", round((monthly_total_sales), 1))),
            vjust = -0.5, 
            size = 3, 
            color = "black") +
  scale_x_date(date_labels = "%m", 
               date_breaks = "1 month") +
  scale_y_continuous(labels = scales::dollar) +
  labs(title = "全体売上傾向",
       x = "月",
       y = "売上（＄）",
       fill = "製品カテゴリ") + 
  theme(plot.title.position = "plot",
        plot.title = element_text(hjust = 0.4))


```

**簡単な考察：**

- 全体的におおむね＄１２０００前後の変動が確認できます。

- 例外として、６月～８月は比較的安定していることがわかります。

- ５月は前後の月と＄１６０００以上の差があり、一年で最も売上が高い月であることが明らかです。

- ９月～１０月の変動は、４月～５月に次ぐ値ではあるものの、１０月以降は全体的な変動の範囲となっていることが観察されます。


以上のことから、５月は売上が最高値∧変動が顕著であることが明白です。したがって、今回の深堀分析では５月の売上に注目します。次に、製品カテゴリ別の売上変動を確認し、要因分析を行います。
<br><br>

### **4.2. 深堀分析** 


#### **製品カテゴリごとの傾向**

**仮説：** ５月の売上が顕著なのは、特定の製品カテゴリの売上変動によるものであると仮定します。
<br><br>

**折れ線グラフ**

```{r 製品カテゴリ別の傾向, echo=FALSE}
# 折れ線グラフ
ggplot(data = overall_sales) + 
  geom_line(data = overall_sales %>%
              filter(product_category != "Electronics"), 
            aes(x = date, 
                y = monthly_category_sales, 
                color = product_category), 
            linetype = "dashed",
            linewidth = 0.8) +
  geom_line(data = overall_sales %>%
              filter(product_category == "Electronics"), 
            aes(x = date, 
                y = monthly_category_sales, 
                color = product_category), 
            linewidth = 1.5) +
  scale_x_date(date_labels = "%m", 
               date_breaks = "1 month")  +
  scale_y_continuous(labels = scales::dollar) +
  labs(title = "製品カテゴリ別の売上傾向",
       x = "月",
       y = "売上（＄）",
       color = "製品カテゴリ") + 
  theme(plot.title.position = "plot",
        plot.title = element_text(hjust = 0.4))


```

**簡単な考察：**

- 全体的に、どの製品カテゴリにも大きな売り上げ変動が見受けられます。

- 「Electronics（家電）」は、年間を通して最も激しく変動していることが確認できます。

- すべての製品カテゴリの売上が増加しているのは、４月～５月にかけてと、９月～１０月にかけてであることがわかります。

- すべての製品カテゴリの売上が減少しているのは、５月～６月にかけてと、８月～９月にかけてであることが観察されます。

以上のことから、５月の全体売上には「Electronics（家電）」の寄与が大きいことが明白です。よって、「Electronics（家電）」の５月の売上変動の要因を分析する必要があると考えられます。
<br><br>

#### **顧客属性**

**仮説：** ５月の「Electronics（家電）」の売上変動が顕著なのは、特定の顧客属性によるものであると仮定します。


**注釈：**
本分析における顧客属性は、バイアスを避けるために、性別は含めず年齢層のみの属性分けとしました。また、年齢層に関しては、ライフステージを基準に区分しました。
<br><br>

```{r 顧客属性, echo=FALSE}
# 年齢層: 18-24歳層, 25-34歳層, 35-44歳層, 45-54歳層, 55-64歳層
sales_age <- sales_use %>%
  mutate(age_group = case_when(Age >= 18 & Age < 25 ~ "１８－２４歳層",
                               Age >= 25 & Age < 35 ~ "２５－３４歳層",
                               Age >= 35 & Age < 45 ~ "３５－４４歳層",
                               Age >= 45 & Age < 55 ~ "４５－５４歳層",
                               TRUE ~ "５５－６４歳層"))


customer_attributes <- sales_age %>%
  group_by(month, age_group) %>%
  summarise(age_count = n(), 
            .groups = "drop") %>%
  group_by(month) %>%
  mutate(total_count = sum(age_count),　　
         age_ratio = age_count/total_count,
         date = as.Date(paste0("2023-", month, "-01"))) %>%
  ungroup() %>%
  mutate(age_group = factor(age_group, levels = c("１８－２４歳層", "２５－３４歳層", "３５－４４歳層", "４５－５４歳層", "５５－６４歳層"))) %>%
  select(date, month, everything()) %>% 
  arrange(month, factor(age_group, levels = c("１８－２４歳層", "２５－３４歳層", "３５－４４歳層", "４５－５４歳層", "５５－６４歳層")))
  



```

**積み上げ棒グラフ**

```{r グラフ：顧客属性, echo=FALSE}
# 積み上げ棒グラフ
ggplot(data = customer_attributes) +
  geom_col( 
            aes(x = date, 
                y= age_ratio, 
                fill = age_group)) +
  scale_x_date(date_labels = "%m", 
               date_breaks = "1 month") + 
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title = "顧客年齢層の月別構成比",
       x = "月",
       y = "構成比（％）",
       fill = "年齢層",
       caption = "年齢層：１８－２４歳層, ２５－３４歳層, ３５－４４歳層, ４５－５４歳層, ５５－６４歳層") + 
  theme(plot.title.position = "plot",
        plot.title = element_text(hjust = 0.4))


```

**簡単な考察：**

- 年間で見ると、年齢層の構成割合はおおよそ±８％前後の変動があることが観察されます。

- 全体的な傾向として、「１８－２４歳層」の構成割合がほかの年齢層と比較して小さいことが確認できます。

- 各年齢層の構成割合において、最大の変動が観察されるのは以下の月です：

    - １８－２４歳層： １０月～１１月
    - ２５－３４歳層： １１月～１２月
    - ３５－４４歳層： ３月～４月
    - ４５－５４歳層： ８月～９月
    - ５５－６４歳層： ２月～３月

- 各年齢層の構成割合はどの月においても比較的均等(最大構成比３０％、HHI = 0.21)で、明確な偏りは見受けられませんでした。


以上のことから、特定の顧客属性が５月の「Electronics（家電）」の売上変動の要因とはいえないことは明白です。また、年間を通してみても顧客属性による特定の製品カテゴリの売上への明確な影響を示唆できる変化は見受けられませんでした。したがって、顧客属性は売上変動の主因とはいえません。 よって、「Electronics（家電）」単体に限定した要因は確認できないことが明らかであるため、すべての製品カテゴリを含めた５月の売上全体を左右する要因に分析の軸を移します。
<br><br>

#### **来店人数・平均取引単価**

**仮説：** ５月の売上変動に寄与するものは、「来店人数」および「単価」によるものであると仮定します。

<br><br>
```{r 来店人数・平均取引単価, echo=FALSE}
# 来店人数
monthly_customers <- sales_use %>%
  group_by(month) %>%
  summarise(customer_count = n_distinct(customer_id)) %>% 
  mutate(date = as.Date(paste0("2023-", month, "-01"))) %>%
  select(date, month, everything())

customer_labels <- monthly_customers %>%
  filter(customer_count %in% c(max(customer_count), min(customer_count)) | date %in% as.Date(c("2023-05-01"))) %>%
  mutate(vjust = case_when(customer_count == min(customer_count) ~ 1.2,
                              TRUE ~ -1)) 


# 単価
monthly_transactions <- sales_use %>%
  group_by(month) %>%
  summarise(monthly_sales = sum(total_amount, na.rm = TRUE),
            transaction_count = n_distinct(transaction_id)) %>%
  mutate(avg_sales_per_transaction = monthly_sales/transaction_count,
         date = as.Date(paste0("2023-", month, "-01"))) %>%
  select(date, month, everything()) %>%
  ungroup() %>%
  mutate(across(avg_sales_per_transaction, ~round(.x, 2)))


transaction_labels <- monthly_transactions %>% 
  filter(avg_sales_per_transaction %in% c(max(avg_sales_per_transaction), min(avg_sales_per_transaction)) | date %in% as.Date(c("2023-05-01"))) %>%
  mutate(vjust = case_when(avg_sales_per_transaction == min(avg_sales_per_transaction) ~ 1.2,
                              TRUE ~ -1))



```

**折れ線グラフ**

```{r グラフ, fig.width=10,  echo=FALSE}
# 折れ線：来店人数
number_of_customers <- ggplot(
  data = monthly_customers, 
  aes(x = date, 
      y = customer_count)) + 
  geom_line(color = "blue", 
            linewidth = 1.5) +
  geom_text(data = customer_labels,
            aes(label = customer_count, 
                vjust = vjust), 
            size = 3, 
            color = "black") +
  scale_x_date(date_labels = "%m", 
               date_breaks = "1 month") + 
  labs(title = "月次来店人数",
       x = "月",
       y = "人数") + 
  theme(plot.title.position = "plot",
        plot.title = element_text(hjust = 0.5))



# 折れ線： 単価
average_transaction_amount <- ggplot(
  data = monthly_transactions, 
  aes(x = date, 
      y = avg_sales_per_transaction)) +
  geom_line(color = "lightblue3", 
            linewidth = 1.5) +
  geom_text(data = transaction_labels,
            aes(label = paste0("$", round((avg_sales_per_transaction), 2)), 
                vjust = vjust), 
            size = 3, 
            color = "black") +
  scale_x_date(date_labels = "%m", 
               date_breaks = "1 month") +
  scale_y_continuous(labels = scales::dollar) + 
  labs(title = "月別の平均取引単価",
       x = "月",
       y = "単価（＄）") + 
  theme(plot.title.position = "plot",
        plot.title = element_text(hjust = 0.5))


number_of_customers | average_transaction_amount


```


**簡単な考察：**

- 来店人数：

  - 年間を通じて大きく変動していることが確認されます。 
  
  - ５月に最高値（１０５人）、９月に最低値（６５人）を記録していることが観察されます。

  - ４月～５月にかけては１９人の増加、５月～６月にかけては２８人の減少と、明確に５月の来店人数が突出していることがわかります。
  
- 平均取引単価：

  - 全体的に激しく変動しており、高値と低値が二極化していることが観察されます。
  
  - 最高値は２月の＄５１８．３５、最低値は９月の＄３６３．３８であることが確認できます。
  
  - ５月に着目すると、その単価はは２月に次ぐ＄５０６．１９であることが明らかです。 
  
  - ４月～５月にかけては約＄１１２の増加、５月～６月にかけては約＄３０の減少となっていることがわかります。
  
以上のことから、５月の売上変動には来店人数および単価の双方共に寄与しており、いずれか一方のみでは十分に説明できないことが明らかになりました。また、来店人数については全体売上の変動パターンと強く一致するものの、データの性質上、これ以上の分析は困難であるといえます。一方で、単価については一部の月で全体売上との動きが乖離しており、特に２月の単価が５月を上回っていることがわかります。したがって、単価を構成する要因の分析が必要であると考えます。
<br><br>



#### **販売個数・平均購入点数**

**仮説：** 単価変動の要因は、商品が多く売れたことで単価が高まったと考えられるため、販売個数及び平均購入点数であると仮定します。
<br><br>

```{r 販売個数・平均購入点数, include=FALSE}
# 販売個数
monthly_quantities <- sales_use %>%
  group_by(month, product_category) %>%
  summarise(quantity_sold_by_category = sum(Quantity, na.rm = TRUE),
            .groups = "drop") %>%
  group_by(month) %>%
  mutate(total_quantity_sold = sum(quantity_sold_by_category, na.rm = TRUE), 
         date = as.Date(paste0("2023-", month, "-01"))) %>%
  select(date, month, everything())


# 平均購入点数
average_purchase_quantity <- sales_use %>%
  group_by(month) %>%
  summarise(total_quantity = sum(Quantity, na.rm = TRUE),
            transaction_count = n_distinct(transaction_id)) %>%
  mutate(avg_quantity_per_transaction = total_quantity/transaction_count,
         date = as.Date(paste0("2023-", month, "-01"))) %>%
  select(date, month, everything())


```

```{r 折れ線グラフ（２）, include=FALSE}
# 折れ線：販売個数
sold_quantity_graph <- ggplot(data = monthly_quantities) + 
  geom_line(aes(x = date, y = quantity_sold_by_category, color = product_category), linewidth = 1) +
  geom_line(aes(x = date, y = total_quantity_sold), linewidth = 1) +
  scale_x_date(date_labels = "%m", 
               date_breaks = "1 month") + 
  labs(title = "月別の販売個数",
       x = "月",
       y = "個数") + 
  theme(plot.title.position = "plot",
        plot.title = element_text(hjust = 0.6))


# 折れ線：平均購入点数
avg_purchase_quantity_graph <- ggplot() +
  geom_line(data = average_purchase_quantity, 
            aes(x = date, 
                y = avg_quantity_per_transaction), 
            linewidth = 1) +
  scale_x_date(date_labels = "%m", 
               date_breaks = "1 month") + 
  labs(title = "月別の平均購入点数",
       x = "月",
       y = "平均購入点数") + 
  theme(plot.title.position = "plot",
        plot.title = element_text(hjust = 0.6))


sold_quantity_graph | avg_purchase_quantity_graph


```

**簡単な考察：**

記述統計の結果、平均購入点数は年間を通してほとんど変化が確認できず（mean = 2.52, sd = 0.11)、有意な要因とはいえないことが明らかとなりました。また、販売個数の変動パターンは全体売上と一致していることが観察されました。このことから、販売個数の変化は来店人数に起因していると考えられます。したがって、販売個数・平均購入点数の側面からは単価変動を説明できません。そのため、分析上グラフで示す価値がほとんどなく、可視化は省略します。以上を踏まえて、単価変動の要因は値段そのものの変化にあると推測します。

<br><br>


#### **製品カテゴリ別平均販売価格および販売割合**

**仮説：** 単価変動は、製品カテゴリ別平均販売価格および販売割合の相乗効果によるものであると仮定します。 

<br><br>

```{r 平均販売価格・販売割合, echo=FALSE}
# 平均販売価格
monthly_prices <- sales_use %>%
  group_by(month, product_category) %>%
  summarise(avg_sold_price = mean(unit_price, na.rm = TRUE),
            .groups = "drop") %>%
  mutate(date = as.Date(paste0("2023-", month, "-01"))) %>%
  select(date, month, everything())




# 販売割合
monthly_ratios <- monthly_quantities %>% 
  mutate(product_ratio = quantity_sold_by_category/total_quantity_sold) %>% 
  rename(quantity_sold_by_product = quantity_sold_by_category)
  


```

**折れ線グラフおよび積み上げ棒グラフ**

```{r 折れ線グラフおよび積み上げ棒グラフ, fig.width=12,  echo=FALSE}
# 折れ線グラフ：平均販売価格

avg_sold_product_price <- ggplot() +
  geom_line(data = monthly_prices, 
            aes(x = date, y = avg_sold_price, color = product_category), 
            linewidth = 1) +
  scale_x_date(date_labels = "%m", 
               date_breaks = "1 month") + 
  labs(title = "月別の平均販売価格",
       x = "月",
       y = "平均販売価格（＄）") + 
  theme(plot.title.position = "plot",
        plot.title = element_text(hjust = 0.45))



# 積み上げ棒グラフ： 販売割合
product_ratio <- ggplot() +
  geom_col(data = monthly_ratios,
           aes(x = date, 
                y= product_ratio, 
                fill = product_category)) +
  scale_x_date(date_labels = "%m", 
               date_breaks = "1 month") + 
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title = "月別の販売割合",
       x = "月",
       y = "販売割合（％）",
       fill = "製品カテゴリ") + 
  theme(plot.title.position = "plot",
        plot.title = element_text(hjust = 0.45))

avg_sold_product_price / product_ratio


```
<br><br>

**簡単な考察：**

まず、前月との単価変動が顕著な月に着目すると、３月（減少）と１０月（増加）が挙げられます。

３月は、「Beauty（美容・パーソナルケア）」が最高値を記録していたものの販売割合が小さく、全体の単価を押し上げる効果は限定的でした。また、販売割合の約６割を占める「Clothing（衣類）」は通年で２番目に低い価格、残る「Electronics（家電）」も３番目に低い価格であったため、全体の単価は低下が観察されました。

１０月は、前月と比較してすべての製品カテゴリの価格が増加していることが確認できます。その中でも特に増加幅が大きく高価格となった「Beauty（美容・パーソナルケア）」の販売割合の増加も相まって、全体単価が大きく上昇する結果となりました。

続いて、単価が２月に次ぐ高水準である５月は、「Electronics（家電）」が最高値、「Clothing（衣類）」が３番目に高い値といずれも高水準であったことに加え、両者の販売割合がともに約３７．５％と高かったことが寄与していると考えられます。

以上のことから、単価変動の要因は製品カテゴリごとの価格と割合の相乗効果であるといえます。


補足：単価が最高値を記録した２月に関しては、明確な要因は確認できませんでした。これ以上の分析は本筋からずれるため本レポートの範囲外とします。
<br><br>


## **5. 結論**


これまでの分析を総合すると以下のようなことが明らかとなりました：


**主要な発見**

- 売上変動の要因は「来店人数」と「平均取引単価」であり、顧客属性や特定の製品カテゴリによるものではありませんでした。

- 単価変動は、「平均販売価格（製品カテゴリ別）」と「販売割合」の相乗効果によるもので、「平均購入点数」は寄与していませんでした。

- ５月の「Electronics（家電）」の顕著な売上増加は、「平均販売価格」と「販売割合」の大きな増加が重なったことに起因していました。

<br><br>

**ビジネス提案**

- 売上向上に向けた取り組みは、「来店人数」の増加施策と「平均取引単価」の変動に注目することが有効と考えられます。

- 特定の製品カテゴリの「平均販売価格」や「販売割合」の変動が「平均取引単価」変動に強く影響しており、これらをモニタリングすることで、収益予測の精度向上につながる可能性があります。

- 「平均販売価格」の上昇と「販売割合」の増加が同時に起こる局面は、売上拡大の重要な観察指標となりえることが示唆されています。

上記観点を基に、マーケティング・商品企画部門と連携し、特定の製品カテゴリの「平均販売価格」変動や「販売割合」変化を活かした施策検討が有効と考えられます。

<br><br>

**制約**

- データ数が１０００件と少なく、統計的有意性を確認できていません。

- 架空の小売店であるがゆえに周辺地理情報がなく、来店人数、顧客属性、季節性などを十分にとらえられていない可能性があります。


- 仕入れ値のデータが含まれていないため、製品カテゴリごとの利益率を考慮できていません。
<br><br>

**今後の展望**

これらの制約を踏まえ、今後の分析では以下の視点を取り入れることで、より実態に即した洞察の獲得が期待されます。

- データ件数を増やし、統計分析を再度試行すること。

- 周辺地理情報を含め、周辺環境から来店人数や顧客属性のさらなる分析、位置情報から季節性の影響を考慮し新たな知見を得ること。

- 仕入れ値などの情報を含め、利益率の側面からより詳細なKPIに寄与する要因の分析を行うこと。
<br><br>

