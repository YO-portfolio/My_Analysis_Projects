---
title: "ニューヨーク市の航空便遅延に関する分析"
author: "Yoshiki Okada"
date: "2025-08-03"
output: html_document
---

```{r setup, include=FALSE}
library("tidyverse")  
library("conflicted")
library("nycflights13")
library("lubridate")
conflict_prefer("filter", "dplyr")
conflict_prefer("lag", "dplyr")

knitr::opts_chunk$set(echo = TRUE)
```

## **はじめに**

本レポートは、2013年におけるニューヨーク市の空港でのフライト遅延パターンを分析したものです。
分析には ”nycflights13” データセットを用い、遅延率の月別および時間帯別の変動に焦点を当て、主要な傾向を明らかにしています。
本プロジェクトは、実際のビジネス環境を想定し、データ分析および可視化スキルを実践的に活用することを目的としています。
<br><br>

## **データの出典**

本分析で使用したデータは、CRANで公開されているRのパッケージ**nycflights13** (Wickham, 2018)に収録されているものです。

-   パッケージ URL: <https://CRAN.R-project.org/package=nycflights13>
<br><br>

## **データの概要**

データセット”nycflights13”には、2013年にニューヨーク市内の空港（JFK＝ジョン・F・ケネディ国際空港、LGA＝ラガーディア空港、EWR＝ニューアーク・リバティー国際空港）から出発した30万件を超えるフライトに関する詳細な情報が含まれています。本分析で用いた変数は以下の通りです：

- year, month, day: フライトの日付

- carrier: 航空会社コード

- sched_dep_time: 予定出発時刻

- dep_time: 実際の出発時刻

- origin: 出発空港 (JFK、LGA、EWR)

- dest: 到着空港

その他の変数に関しては、本分析で使用しないため割愛させていただきます。
<br><br>

## **データの整形と前処理**

本分析では、主要変数に含まれる欠損値や異常値（例：無限値）について確認を行い、バイアスの最小化を目的として一括削除しました。また、本分析と直接関係のない変数についても同様に削除しています。

具体的には、尾翼番号や便番号などの各便を一意に識別する変数は、本分析の目的である「月別・時間帯別の遅延傾向の把握」に寄与しないため除外しました。さらに、すべての便がニューヨーク市の空港（JFK,LGA,EWR）から出発することから、到着時刻や飛行距離・飛行時間などの到着関連変数も不要と判断し、削除しています。

```{r 整形と前処理}
library("nycflights13")

flight_df <- flights %>%
  na.omit()

flight_remove_unnec <- flight_df %>%
  select(-c(flight, tailnum, air_time, distance))

flight_use <- flight_remove_unnec %>%
  select(-c(arr_time, arr_delay, sched_arr_time, hour, minute))
```
<br><br>

## **分析手法の説明**

本分析では、航空便の遅延率に影響を与える要因を調査するため、可視化および重回帰分析を用いました。

**手法:** 
まず、月別および時間帯別における遅延率の傾向を把握するため、グラフによる可視化を行いました。続いて、これら二つの変数が遅延率に与える相互的・複合的な影響を検討するため、ヒートマップによる可視化と重回帰モデルを構築しました。

なお、個々の変数に対する単回帰分析は実施していません。これは、重回帰モデルにより、各変数の独立した影響とその組み合わせによる効果を同時に評価できると判断したためです。

**手法選定の意図:** 
グラフによる可視化は、各要因が遅延に与える影響、すなわち傾向や潜在的な関係性を直感的に把握するための補助を目的として選択しました。。
続いて実施した重回帰分析では、複数の要因を同時に考慮することで交絡要因の影響を排除し、より厳密かつ定量的にそれぞれの要因の効果を評価することを目的として選択しました。

**モデルの概要:** 

重回帰分析においては、1月および朝の時間帯を基準カテゴリーとして設定し、その他の月および時間帯が遅延率に与える追加的な影響を推定しています。

※時間帯（Time Slot）は、実際の空港運営状況に基づいて設定されており、時間を均等に分割したものではありません。実際の航空便の集中時間帯に応じた区切りとなっています。
<br><br>

## **結果とコード**

本セクションでは、3つの可視化グラフおよび1つの重回帰分析を通じて、航空便の遅延パターンを多角的に検討します。
はじめに、月別および時間帯別の遅延傾向を個別にグラフで可視化します。
次に、これら2変数の交互作用的な影響を示すために、ヒートマップを用いた可視化を行います。
最後に、重回帰モデルを用いて、月と時間帯が遅延率に与える影響を定量的に分析します。
<br><br>

#### **ステップ 1: 月別分析**

**データの集計:**

まず、月別の便数を集計し、”遅延”と”定刻通り”に分類しました。

```{r}
mflight_nom_del <- flight_use %>%
  group_by(month) %>%
  summarise(f_num = n(), 
            f_delay = sum(dep_delay > 0, na.rm = TRUE),
            f_normal = f_num - f_delay)
```

続いて、可視化に際し、集計されたデータをロング形式に変換しました。

```{r}
mflight_nom_del_long <- mflight_nom_del %>%
  pivot_longer(cols = c(f_delay, f_normal),
               names_to = "status",
               values_to = "count") %>%
  mutate(status = factor(status, levels = c("f_normal", "f_delay")))
```

最後に遅延率の集計を行いました。

```{r}
mflight_del_rate <- mflight_nom_del_long %>%
  filter(status == "f_delay") %>%
  mutate(delay_rate = count/f_num)
```

**可視化: グラフ**

```{r}
ggplot(data = mflight_nom_del_long, 
       aes(x = factor(month) , 
           y = count, 
           fill = status)) + 
  geom_col(position = "stack") +
  geom_text(data = mflight_del_rate, 
            aes(x = factor(month), 
                y = count/2, 
                label = paste0(round(delay_rate * 100, 1), "%")),
            color = "black", 
            size = 3) + 
  labs(title = "月別の便数（遅延・定刻）とその遅延率",
       x = "月",
       y = "便数")+ 
  scale_fill_manual(values = c("f_delay" = "red", "f_normal" = "blue"), 
                    labels = c("定刻通り", "遅延")) + 
  theme_minimal()
```

**簡単な考察:**

-　遅延率は、４月～７月のピークにかけて徐々に増加しています。
-　遅延率は、９月～１１月にかけて比較的低い状態が続いたものの、１２月に突如として上昇しています。

<br><br>

#### **ステップ 2: 時間帯別分析**

**データの集計:**

本セクションは、ステップ１にて記載した集計方法と同様の集計過程であるため省略します。

```{r time-slot, include=FALSE}

t_zone_flight <- flight_use %>%
  mutate(time_slot = case_when(sched_dep_time >= 500 & sched_dep_time < 1200 ~ "朝",
                               sched_dep_time >= 1200 & sched_dep_time < 1700 ~ "午後",
                               sched_dep_time >= 1700 & sched_dep_time < 2100 ~ "夕方",
                               TRUE ~ "夜"))


tzflight_nom_del <- t_zone_flight %>%
  group_by(time_slot) %>%
  summarise(f_num = n(), 
            f_delay = sum(dep_delay > 0, na.rm = TRUE),
            f_normal = f_num - f_delay)



tzflight_nom_del_long <- tzflight_nom_del %>%
  pivot_longer(cols = c(f_delay, f_normal),
               names_to = "status",
               values_to = "count") %>%
  mutate(status = factor(status, levels = c("f_normal", "f_delay")),
         time_slot = factor(time_slot, levels = c("朝", "午後", "夕方", "夜")))



tzflight_del_rate <- tzflight_nom_del_long %>%
  filter(status == "f_delay") %>%
  mutate(delay_rate = count/f_num)

knitr::opts_chunk$set(echo = TRUE)
```

**可視化: グラフ**

```{r}

# 時間帯（time_slot）に関しては、前述したとおり実際の航空便の集中時間帯に応じた分割となっています。 

ggplot(data = tzflight_nom_del_long, aes(x = factor(time_slot) 
                                        , y = count, fill = status)) + 
  geom_col(position = "stack") +
  geom_text(data = tzflight_del_rate, 
            aes(x = factor(time_slot), y = count/2, 
                label = paste0(round(delay_rate * 100, 1), "%")),
            color = "black", size = 3) + 
  scale_y_continuous(labels = scales::comma,
                     breaks = seq(0, 150000, by = 25000),
                     limits = c(0, 150000)) + 
  labs(title = "時間帯別の便数（遅延・定刻）とその遅延率",
       x = "時間帯",
       y = "便数",
       caption = "時間帯: 朝 (5:00 - 11:59), 午後 (12:00-16:59), 夕方 (17:00-20:59), 夜 (21:00-23:59)") + 
  scale_fill_manual(values = c("f_delay" = "red", "f_normal" = "blue"), 
                    labels = c("On Time", "Delayed")) + 
  theme_minimal()
```

**簡単な考察:**

-　便数は朝から夜にかけて減少しています。
-　一方で、遅延率は便数の最も多い朝の時間帯が最低値となっています。

※便数の偏りは、時間幅が均等ではないことに起因します。

<br><br>

#### **ステップ 3: 月別および時間帯別分析**

**データの集計:**

本セクションは、ステップ１にて記載した集計方法と同様の集計過程であるため省略します。
```{r  mon-time, include=FALSE}

tzmflight_nom_del <- t_zone_flight %>%
  group_by(month, time_slot) %>%
  summarise(f_num = n(), 
            f_delay = sum(dep_delay > 0, na.rm = TRUE),
            f_normal = f_num - f_delay)


tzmflight_nom_del_long <- tzmflight_nom_del %>%
  pivot_longer(cols = c(f_delay, f_normal),
               names_to = "status",
               values_to = "count") %>%
  mutate(status = factor(status, levels = c("f_normal", "f_delay")),
         time_slot = factor(time_slot, levels = c("朝", "午後", "夕方", "夜")))

  

tzmflight_del_rate <- tzmflight_nom_del_long %>%
  filter(status == "f_delay") %>%
  mutate(delay_rate = count/f_num)



tzmflight_nom_del_long_edt2 <- tzmflight_nom_del_long %>%
  left_join(tzmflight_del_rate %>%
              select(month, time_slot, delay_rate), 
            by = c("month", "time_slot"))

knitr::opts_chunk$set(echo = TRUE)
```

**可視化: グラフ**

```{r}
ggplot(data = tzmflight_nom_del_long_edt2, aes(x = factor(month), y = time_slot, fill = delay_rate)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red", labels = scales::percent_format()) +
  labs(title = "月別および時間帯別の遅延率",
       x = "月", y = "時間帯", fill = "遅延率") +
  theme_minimal()
```

**簡単な考察:**

-　一年を通して、遅延率が低いのは朝の時間帯となっています。
-　９月から１１月は、時間帯に関係なく遅延率が最も低い時期となっています。
<br><br>

#### **ステップ 4: 回帰分析**

月と時間帯が遅延率に与える影響を定量化するために、重回帰分析を実施しました。

```{r}
model_tzm <- lm(delay_rate*100 ~ factor(month) + factor(time_slot), data = tzmflight_nom_del_long_edt2)

summary(model_tzm)

```

**モデルの要約:**

この回帰モデルは遅延率の変動を高精度で説明しています。
決定係数（R²）は0.9403であり、全体の分散の約94%が本モデルによって説明されていることを示しています。
また、F値（91.14、p < 0.001）から、モデル全体が統計的に有意であると判断できます。残差標準誤差（3.537）は、予測誤差がおおよそ±3.5ポイント程度の範囲に収まることを意味します。
<br><br>

**簡単な考察:**

-　基準カテゴリーである「1月の朝の時間帯」における遅延率は、21.44%と推定されました。

-　同じ時間帯（朝）で比較した場合、6月のフライトは1月に比べて約13.31ポイント高い遅延率が見られました。

-　時間帯の違いに着目すると、夕方のフライトは朝のフライトと比較して、遅延率が約25.88ポイント上昇する傾向にあります。

-　１２月の朝の時間帯における遅延率は、前後の月と比較して異常に高い数値を示しています。これは、季節的な天候の影響や休暇シーズンの混雑などが要因と考えられます。

-　以上の結果から、月別および時間帯の要因は、ニューヨーク市内の空港における遅延率に大きく影響していることが明らかとなりました。特に、夏季・夕方・12月において、遅延率が高まる傾向があります。
<br><br>

## **結論**

#### **主要な発見:**

-　本分析により、ニューヨーク市内の空港における航空便の遅延率には明確な季節的・時間帯別の傾向が存在することが明らかになりました。

-　夏季（特に６～８月）および夕方の時間帯では、遅延率が一貫して高く、運航上の混雑が生じやすい時期であることが裏付けられました。

-　12月は、7月と並ぶ高い遅延率を示しており、これは年末の旅行需要の増加や冬季の悪天候の影響によるものと考えられます。　
<br><br>

#### **実務への示唆:**

-　旅行代理店や空港運営当局は、今回の分析結果を活用することで、ピークシーズンや特定の時間帯における遅延リスクを事前に把握し、対策を講じやすくなると考えられます。

-　また、航空会社別に遅延傾向を分析することで、特定のキャリアに合わせたよりきめ細かな対応策の策定にもつながる可能性があります。
<br><br>

#### **本分析における制約:**

-　本分析では、月別および時間帯別に集計したデータを用いており、特定の日や天候要因といったより細かな変動を捉えることが難しい可能性があります。

-　天候状況、航空会社ごとの運航方針、航空管制の介入など、遅延パターンに影響を与えると考えられる重要な要因が分析には含まれていません。

-　モデルでは「月」と「時間帯」の加法的な効果を前提としており、両者の相互作用を考慮していないため、実際の複雑な依存関係を単純化している可能性があります。
<br><br>

#### **今後の展望:**

-　日単位や時間単位など、より細かい時間軸での分析や、天候データなどの追加変数の導入により、予測精度の向上が期待されます。

-　航空会社ごとの遅延パターンを検証することで、運用上の違いが明らかとなり、より効果的な対策立案に資すると考えられます。

-「月」と「時間帯」の相互作用効果を分析対象とすることで、遅延の発生メカニズムに関する理解が一層深まることが期待されます。
<br><br>

